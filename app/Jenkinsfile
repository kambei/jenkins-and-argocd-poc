pipeline {
    agent { docker { image 'alpine/git' } }

    environment {
        # Image name is now local and does not require a Docker Hub username prefix
        DOCKER_IMAGE_NAME = 'poc-web-app'
        # Creates a unique tag based on the Jenkins build number
        IMAGE_TAG = "build-${env.BUILD_NUMBER}"
        # Path to the GitOps repo mounted via Docker Compose volume
        K8S_CONFIG_PATH = '/var/jenkins_home/workspace/gitops-config/deployment-dev.yaml'
    }

    stages {
        stage('Build Local Docker Image') {
            steps {
                script {
                    echo "Starting local build for tag: ${IMAGE_TAG}"
                    // Build the Docker image. Docker Desktop K8s uses this local cache.
                    docker.build("${DOCKER_IMAGE_NAME}:${IMAGE_TAG}", ".")
                    echo "Image built locally: ${DOCKER_IMAGE_NAME}:${IMAGE_TAG}"
                }
            }
        }

        stage('Update GitOps Manifest') {
            steps {
                sh """
                # 1. Update the image tag in the K8s deployment manifest (Simulates a git commit)
                echo "Updating K8s deployment file at ${K8S_CONFIG_PATH} with new image tag: ${IMAGE_TAG}"

                # Use sed to replace the placeholder image tag with the new image tag
                sed -i "s|image: ${DOCKER_IMAGE_NAME}:v0.0.0-PLACEHOLDER|image: ${DOCKER_IMAGE_NAME}:${IMAGE_TAG}|g" ${K8S_CONFIG_PATH}

                # 2. ArgoCD will now automatically detect this change and deploy the new image from the local cache.
                echo "GitOps config updated. ArgoCD is expected to deploy the new image shortly."
                """
            }
        }
    }

    post {
        always {
            echo 'Pipeline finished.'
        }
    }
}